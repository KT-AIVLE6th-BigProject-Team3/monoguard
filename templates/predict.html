<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>MonoGuard - 장비 상세정보</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <link rel="stylesheet" href="/static/css/prj.css" />

    <style>
      /* 왼쪽 장비 목록 */
      .equipment-list {
        width: 300px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .list-title {
        font-size: 18px;
        font-weight: bold;
        color: #4e73df;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e3e6f0;
      }

      /* 오른쪽 상세 정보 */
      .detail-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .info-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .info-table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
      }

      .info-table th,
      .info-table td {
        padding: 12px;
        border: 1px solid #e3e6f0;
      }

      .info-table th {
        background-color: #f8f9fc;
        color: #4e73df;
        font-weight: bold;
      }
    </style>
  </head>

  <body id="page-top">
    <div id="wrapper">
      <!-- 메뉴 영역 -->
      <div id="menu"></div>

      <!-- 메인 콘텐츠 영역 -->
      <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
          <!-- 상단바 영역 -->
          <div id="topbar"></div>

          <!-- 페이지 콘텐츠 -->
          <div class="container-fluid">
            <!-- 페이지 제목 -->
            <div
              class="d-sm-flex align-items-center justify-content-between mb-4"
            >
              <h1 class="h3 mb-0 text-gray-800">장비 상세정보</h1>
            </div>

            <!-- 콘텐츠 영역 -->
            <div class="row">
              <!-- 왼쪽 영역 - 장비 목록 -->
              <div class="col-lg-3">
                <div class="card shadow mb-4">
                  <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">장비 목록</h6>
                  </div>
                  <div class="equipment-card-body">
                    {% for device in deviceList %}
                    <div class="equipment-item">
                      <span class="equipment-name">{{ device.device_id }}</span>
                      {% if device.recent_state == 0 %}
                      <span class="equipment-status text-success">정상</span>
                      {% elif device.recent_state == 1 %}
                      <span class="equipment-status text-caution">관심</span>
                      {% elif device.recent_state == 2 %}
                      <span class="equipment-status text-warning">경고</span>
                      {% elif device.recent_state == 3 %}
                      <span class="equipment-status text-danger">위험</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <!-- 페이지네이션 추가 -->
                <!--<div class="pagination-container">-->
                  <!--<div class="pagination">-->
                    <!--{# {% if current_page > 1 %} #}-->
                      <!--{#<a href="?page={{ current_page - 1 }}">#}-->
                        <!--<button>&lt;</button>-->
                      <!--</a>-->
                    <!--{#{% endif %}#}-->
                    
                    <!--{#{% for p in page_range %}-->
                      <!--{#{% if p == current_page %}#}-->
                        <!--{#<button class="active">{{ p }}</button>#}-->
                      <!--{#{% else %}#}-->
                        <!--{#a href="?page={{ p }}">#}-->
                          <!--{#<button>{{ p }}</button>#}-->
                        <!--</a>-->
                      <!--{#{% endif %}#}-->
                    <!--{#{% endfor %}#}-->

                    <!--{#{% if current_page < total_pages %}#}-->
                      <!--{#<a href="?page={{ current_page + 1 }}">#}-->
                        <!--<button>&gt;</button>-->
                      <!--</a>-->
                    <!--{#{% endif %}#}-->
                  <!--</div>-->
                <!--</div>-->
              </div>
              {% if record_data %}
              <!-- 오른쪽 영역 - 상세 정보 -->
              <div id="info-table-container" class="col-lg-9">
                <!-- 첫 번째 행: 기본 정보 + 장비 상태 이력 -->
                <div class="row">
                  <!-- 기본 정보 카드 -->
                  <div class="col-lg-6">
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          기본 정보
                        </h6>
                      </div>
                      <div class="card-body">
                        <table class="info-table">
                          <thead>
                            <tr>
                              <th>항목</th>
                              <th>내용</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>장비 ID</td>
                              <td>{{ record_data.device_id }}</td>
                            </tr>
                            <tr>
                              <td>수집일시</td>
                              <td>{{ record_data.collection_time }}</td>
                            </tr>
                            <tr>
                              <td>누적가동일</td>
                              <td>{{ record_data.cumulative_operating_day }}일</td>
                            </tr>
                            <!--<tr>-->
                              <!--<td>장비이력</td>-->
                              <!--<td>13회</td>-->
                            <!--</tr>-->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <!-- 장비 상태 이력 카드 -->
                  <div class="col-lg-6">
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          장비 상태 이력
                        </h6>
                      </div>
                      <div class="card-body"></div>
                    </div>
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          장비 상태 이력
                        </h6>
                      </div>
                      <div class="card-body"></div>
                    </div>
                  </div>
                </div>

                <!-- 두 번째 행: 센서 데이터 + 시각화 -->
                <div class="row">
                  <!-- 센서 데이터 카드 -->
                  <div class="col-lg-6">
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          센서 데이터
                        </h6>
                      </div>
                      <div class="card-body">
                        <table class="info-table">
                          <thead>
                            <tr>
                              <th>항목</th>
                              <th>측정값</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>미세먼지(PM1.0)</td>
                              <td>{{ record_data.PM1_0 }}µg/m3</td>
                            </tr>
                            <tr>
                              <td>미세먼지(PM2.5)</td>
                              <td>{{ record_data.PM2_5 }}µg/m3</td>
                            </tr>
                            <tr>
                              <td>미세먼지(PM10)</td>
                              <td>{{ record_data.PM10 }}µg/m3</td>
                            </tr>
                            <tr>
                              <td>온도 측정값(NTC)</td>
                              <td>{{ record_data.NTC }}℃</td>
                            </tr>
                            <tr>
                              <td>전류 측정값(CT1)</td>
                              <td>{{ record_data.CT1 }}A</td>
                            </tr>
                            <tr>
                              <td>전류 측정값(CT2)</td>
                              <td>{{ record_data.CT2 }}A</td>
                            </tr>
                            <tr>
                              <td>전류 측정값(CT3)</td>
                              <td>{{ record_data.CT3 }}A</td>
                            </tr>
                            <tr>
                              <td>전류 측정값(CT4)</td>
                              <td>{{ record_data.CT4 }}A</td>
                            </tr>
                            <!--<tr>-->
                              <!--<td>장비이력</td>-->
                              <!--<td>13회</td>-->
                            <!--</tr>-->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <!-- 센서 데이터 시각화 카드 -->
                  <div class="col-lg-6">
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          센서 데이터 추이
                        </h6>
                      </div>
                      <div class="card-body"></div>
                    </div>
                  </div>
                </div>

                <!-- 세 번째 행: 상태 분석 -->
                <div class="row">
                  <div class="col-lg-12">
                    <div class="card shadow mb-4">
                      <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                          상태 분석
                        </h6>
                      </div>
                      <div class="card-body">
                        <iframe
                          id="statusChart"
                          width="100%"
                          height="315"
                          frameborder="0"
                        ></iframe>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // 메뉴와 상단바 로드
      fetch("/sidebar")
        .then((response) => response.text())
        .then((html) => (document.getElementById("menu").innerHTML = html))
        .catch((error) => console.error("Error loading sidebar:", error));

      fetch("/topbar")
        .then((response) => response.text())
        .then((html) => (document.getElementById("topbar").innerHTML = html))
        .catch((error) => console.error("Error loading topbar:", error));

      // 장비 선택 이벤트 처리
      document.querySelectorAll(".equipment-item").forEach((item) => {
        item.addEventListener("click", function () {
          document.querySelectorAll(".equipment-item").forEach((el) => {
            el.classList.remove("active");
          });
          this.classList.add("active");
        });
      });

      document.querySelectorAll(".equipment-item").forEach((item) => {
        item.addEventListener("click", function () {
          // 이전 선택 해제
          document.querySelectorAll(".equipment-item").forEach((el) => {
            el.classList.remove("active");
          });
          this.classList.add("active");

          // 장비 ID 가져오기 (AGV-001 형식을 agv01 형식으로 변환)
          const deviceId = this.querySelector(".equipment-name").textContent;
          fetch(`/predict/${deviceId}`)  // 예: /predict/AGV-001
            .then((response) => {
              if (!response.ok) {
                throw new Error("장비 정보를 불러오지 못했습니다.");
              }
              return response.text();
            })
            .then((html) => {
              // // info-table-container에 HTML 삽입
              // document.getElementById("info-table-container").innerHTML = html;
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");
              const newInfo = doc.querySelector("#info-table-container");

              if(!newInfo){
                throw new Error("info-table-container를 찾을 수 없습니다.");
              }
              
              document.getElementById("info-table-container").innerHTML = newInfo.innerHTML;
            })
            .catch((error) => {
              console.error(error);
              document.getElementById("info-table-container").innerHTML =
                "<p>장비 상세 정보를 가져오는 중 오류가 발생했습니다.</p>";
            });

          // Streamlit 앱 URL 설정 (실제 URL로 변경 필요)
          //const streamlitUrl = `http://localhost:8502/?device_id=${deviceId}`;

          // iframe 업데이트
          //const iframe = document.getElementById("statusChart");
          //iframe.src = streamlitUrl;
        });
      });
    </script>
  </body>
</html>
