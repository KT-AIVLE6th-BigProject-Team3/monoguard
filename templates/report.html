<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="QnA" />
    <meta name="author" content="황은비" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>MonoGuard</title>

    <!--아이콘이랑 폰트가져오기-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
    />

    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />

    <!--CSS 파일 명시-->
    <link rel="stylesheet" href="../css/prj.css" />

    <!-- 일반적인 fabicon 설정 -->
    <link rel="icon" href="../img/fabicon.svg" />

    <style>
      /* styles.css */
      .custom-control-input:checked ~ .custom-control-label::before {
        border-color: #4e73df;
        background-color: #4e73df;
      }

      .form-group label {
        color: #4e73df;
        font-size: 0.9rem;
      }

      .badge {
        font-size: 0.8rem;
        padding: 0.4em 0.8em;
      }

      .badge-primary {
        background-color: #4e73df;
      }

      .badge-success {
        background-color: #1cc88a;
      }

      .badge-info {
        background-color: #36b9cc;
      }

      .table {
        font-size: 0.9rem;
      }

      .table td,
      .table th {
        vertical-align: middle;
      }

      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      /* 로딩 스피너 */
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .loading-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4e73df;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* 날짜 선택 입력 필드 스타일링 */
      input[type="date"] {
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 0.9rem;
        border: 1px solid #d1d3e2;
        border-radius: 0.35rem;
      }

      input[type="date"]:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
      }

      /* 체크박스와 라디오 버튼 그룹 스타일링 */
      .options-group {
        background-color: #f8f9fc;
        padding: 1rem;
        border-radius: 0.35rem;
        margin-bottom: 1rem;
      }

      /* 버튼 그룹 스타일링 */
      .btn-group-action {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e3e6f0;
      }

      /* 토스트 메시지 스타일 */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem rgba(0, 0, 0, 0.15);
        display: none;
        z-index: 1000;
      }

      .toast.success {
        border-left: 4px solid #1cc88a;
      }

      .toast.error {
        border-left: 4px solid #e74a3b;
      }

      /* 추가 스타일 */
      .gap-3 {
        gap: 1rem !important;
      }

      .form-control {
        height: 38px; /* 모든 입력 필드의 높이 통일 */
      }

      .btn-block {
        height: 38px; /* 버튼 높이를 입력 필드와 동일하게 설정 */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .row.align-items-end > * {
        margin-bottom: 0; /* 하단 마진 제거 */
      }

      /* 반응형 조정 */
      @media (max-width: 768px) {
        .row > * {
          margin-bottom: 1rem;
        }
        .row > *:last-child {
          margin-bottom: 0;
        }
      }
    </style>
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- 메뉴가 동적으로 로드될 영역 -->
      <div id="menu"></div>

      <script>
        // 메뉴를 동적으로 로드
        fetch("./sidebar.html")
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.text();
          })
          .then((html) => {
            document.getElementById("menu").innerHTML = html;
          })
          .catch((error) => console.error("Error loading sidebar:", error));
      </script>

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- 메인 콘텐츠 -->
        <div id="content">
          <!-- 상단바를 삽입할 영역 -->
          <div id="topbar"></div>

          <script>
            // 상단바를 동적으로 로드
            fetch("./topbar.html")
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    "Network response was not ok " + response.statusText
                  );
                }
                return response.text();
              })
              .then((html) => {
                document.getElementById("topbar").innerHTML = html;
              })
              .catch((error) => console.error("Error loading topbar:", error));
          </script>
          <div class="container-fluid">
            <h1 class="h3 mb-0 text-gray-800">보고서 만들기</h1>
            <p class="mb-4">장비와 기간을 선택하여 보고서를 생성하세요</p>

            <div class="card shadow mb-4">
              <div class="card-body">
                <div class="row align-items-end">
                  <!-- align-items-end 추가 -->
                  <div class="col-md-3">
                    <div class="form-group mb-0">
                      <!-- mb-0 추가 -->
                      <label
                        for="deviceSelect"
                        class="text-primary font-weight-bold"
                        >장비 선택</label
                      >
                      <select id="deviceSelect" class="form-control">
                        <option value="">장비를 선택하세요</option>
                        <option value="AGV17">AGV17</option>
                        <option value="AGV18">AGV18</option>
                        <option value="OHT17">OHT17</option>
                        <option value="OHT18">OHT18</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-7">
                    <div class="form-group mb-0">
                      <!-- mb-0 추가 -->
                      <label class="text-primary font-weight-bold"
                        >기간 선택</label
                      >
                      <div class="d-flex gap-3">
                        <!-- gap-3 추가 -->
                        <input
                          type="text"
                          id="startDate"
                          class="form-control"
                          placeholder="시작일"
                        />
                        <input
                          type="text"
                          id="endDate"
                          class="form-control"
                          placeholder="종료일"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <button
                      id="generateReport"
                      class="btn btn-primary btn-block h-100"
                      disabled
                    >
                      <i class="fas fa-file-pdf mr-2"></i>보고서 생성
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div class="loading">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>AI가 보고서 분석 중...</p>
      </div>
    </div>

    <!-- 토스트 메시지 -->
    <div class="toast"></div>

    <!-- Flatpickr 스크립트 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/ko.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const deviceSelect = document.getElementById("deviceSelect");
        const generateBtn = document.getElementById("generateReport");
        const loadingScreen = document.querySelector(".loading");
        const toast = document.querySelector(".toast");
        let selectedStartDate = null;
        let selectedEndDate = null;

        // Flatpickr 초기화
        const dateConfig = {
          locale: "ko",
          dateFormat: "Y-m-d",
          maxDate: "today",
        };

        const startDatePicker = flatpickr("#startDate", {
          ...dateConfig,
          onChange: function (selectedDates) {
            selectedStartDate = selectedDates[0];
            endDatePicker.set("minDate", selectedDates[0]);
            updateGenerateButton();
          },
        });

        const endDatePicker = flatpickr("#endDate", {
          ...dateConfig,
          onChange: function (selectedDates) {
            selectedEndDate = selectedDates[0];
            startDatePicker.set("maxDate", selectedDates[0]);
            updateGenerateButton();
          },
        });

        // 장비 선택 이벤트
        deviceSelect.addEventListener("change", updateGenerateButton);

        // 생성 버튼 활성화 조건 체크
        function updateGenerateButton() {
          generateBtn.disabled = !(
            deviceSelect.value &&
            selectedStartDate &&
            selectedEndDate
          );
        }

        // 보고서 생성 버튼 클릭 이벤트
        generateBtn.addEventListener("click", async () => {
          if (!deviceSelect.value || !selectedStartDate || !selectedEndDate)
            return;

          try {
            loadingScreen.style.display = "flex";

            const startDate = selectedStartDate.toISOString().split("T")[0];
            const endDate = selectedEndDate.toISOString().split("T")[0];
            const response = await fetch(
              `http://localhost:8000/device_report_pdf/${deviceSelect.value}?start_date=${startDate}&end_date=${endDate}`
            );

            if (!response.ok) throw new Error("보고서 생성에 실패했습니다.");

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${deviceSelect.value}_report_${startDate}_${endDate}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast("보고서가 성공적으로 생성되었습니다.", "success");
          } catch (error) {
            console.error("Error:", error);
            showToast("보고서 생성에 실패했습니다.", "error");
          } finally {
            loadingScreen.style.display = "none";
          }
        });

        // 토스트 메시지 표시 함수
        function showToast(message, type = "success") {
          toast.textContent = message;
          toast.className = `toast ${type}`;
          toast.style.display = "block";

          setTimeout(() => {
            toast.style.display = "none";
          }, 3000);
        }
      });
    </script>
  </body>
</html>